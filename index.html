<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABN Utilities Portal</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
 <style>
    :root {
        /* Default Light Theme */
        --primary: #f8f9fa;       
        --dark-text: #1a202c;
        --accent: #38a169;
        --sidebar-width: 280px;
        --sidebar-min: 80px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #1a202c;
        --text-sub: #718096;
        --border-color: #e2e8f0;
    }

    /* DARK MODE SETTINGS */
    body.dark-mode {
        --bg-body: #121212;
        --bg-card: #1e1e1e;
        --primary: #1a1a1a;
        --text-main: #f7fafc;
        --text-sub: #a0aec0;
        --border-color: #2d3748;
        --dark-text: #f7fafc;
    }

    body, html {
        margin: 0; padding: 0;
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        transition: background 0.3s;
    }

    /* --- LAYOUT & CONTENT --- */
    .content { 
        margin-left: var(--sidebar-width); 
        padding: 25px 40px; 
        transition: var(--transition); 
    }
    .content.expanded { margin-left: var(--sidebar-min); }
     /* --- SEARCH BOX FIX --- */
.search-box { 
    padding: 10px 20px; 
    transition: var(--transition); 
    overflow: hidden; /* Para hindi lumampas ang text box */
}

.search-inner {
    background: rgba(0,0,0,0.05); /* Bagong dynamic gray background */
    border-radius: 10px;
    display: flex; 
    align-items: center; 
    padding: 12px;
    min-width: 40px; /* Sukat para sa icon */
}

.search-inner input {
    background: transparent; 
    border: none; 
    color: var(--text-main); 
    margin-left: 10px; 
    outline: none; 
    width: 100%;
    transition: var(--transition);
}

.search-inner i { 
    color: var(--text-sub); 
    min-width: 20px;
    text-align: center;
}

/* --- COLLAPSE LOGIC PARA SA SEARCH --- */
#sidebar.collapsed .search-box {
    cursor: pointer;
    padding: 10px 0 !important; /* Binawasan ang padding sa gilid para mag-center */
    display: flex;
    justify-content: center;
}

#sidebar.collapsed .search-inner {
    justify-content: center;
    width: 45px; /* Fixed width para maging pabilog o square na sakto sa gitna */
    height: 45px;
    padding: 0;
    background: rgba(56, 161, 105, 0.1); 
    border-radius: 10px;
}

#sidebar.collapsed .search-inner i {
    margin: 0; /* Alisin ang margin para sentrong-sentro ang icon */
}

#sidebar.collapsed .search-inner input {
    opacity: 0;
    width: 0;
    margin: 0;
    padding: 0;
    display: none; /* Mas safe na i-none para hindi makaabala sa click */
}

    /* --- STATS GRID --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: var(--bg-card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        border-left: 5px solid var(--accent);
    }
    .stat-card h4 { 
        margin: 0; 
        color: var(--text-sub); 
        font-size: 0.85rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px;
    }
    .stat-card .value { 
        font-size: 1.8rem; 
        font-weight: 800; 
        color: var(--text-main); 
        margin: 10px 0; 
    }
    .stat-card .label { 
        font-size: 0.8rem; 
        color: var(--text-sub); 
        font-weight: 500;
    }

    /* --- CHART --- */
    .chart-container {
        background: var(--bg-card);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        height: 350px;
    }

    /* --- SIDEBAR --- */
    #sidebar {
        width: var(--sidebar-width); 
        background: var(--primary);
        height: 100vh; 
        position: fixed; 
        transition: var(--transition); 
        z-index: 1000; 
        overflow: hidden;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.05); 
        border-right: 1px solid var(--border-color); 
    }
    #sidebar.collapsed { width: var(--sidebar-min); }

    .sidebar-brand {
        height: 80px; display: flex; align-items: center; padding: 0 20px;
        color: var(--dark-text); cursor: pointer; white-space: nowrap;
    }
    .sidebar-logo {
        width: 40px; height: 40px; object-fit: contain; min-width: 40px;
    }
    .nav-item {
        display: flex; align-items: center; padding: 18px 25px;
        color: var(--text-sub); text-decoration: none; cursor: pointer; transition: 0.2s;
    }
    .nav-item.active {
        background: rgba(56, 161, 105, 0.1);
        color: var(--accent);
        border-left: 4px solid var(--accent);
    }
    .nav-item:hover { background: rgba(0,0,0,0.05); color: var(--accent); }
    .nav-item i { font-size: 1.3rem; min-width: 35px; }
    #sidebar.collapsed .nav-item span { display: none; }
    #sidebar.collapsed .sidebar-brand span { opacity: 0; pointer-events: none; }

    /* --- TABLES & FILTERS --- */
    .data-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-top: 20px; }
    .filter-bar { 
        display: flex; align-items: center; gap: 15px; margin-bottom: 20px; 
        background: var(--bg-card); padding: 15px; border-radius: 10px;
        border: 1px solid var(--border-color);
    }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; background: rgba(0,0,0,0.02); color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; border-bottom: 2px solid var(--border-color); }
    td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-main); }
    .text-blue { color: #3182ce; font-weight: bold; }

    /* --- PROFILE & DROPDOWN --- */
    .profile-wrapper { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .profile-circle {
        width: 40px; height: 40px; border-radius: 50%;
        background: url('assets/visor.svg') center/cover no-repeat #edf2f7;
        border: 2px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer;
    }
    .dropdown-menu {
        position: absolute; top: 50px; right: 0;
        background: var(--bg-card); min-width: 220px; border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: none; padding: 8px; border: 1px solid var(--border-color);
    }
    .dropdown-menu.show { display: block; animation: slideDown 0.2s ease; }
    .dropdown-item { padding: 12px; border-radius: 8px; color: var(--text-main); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .dropdown-item:hover { background: rgba(0,0,0,0.05); color: var(--accent); }

    /* --- LOGIN PAGE --- */
    #login-page {
        height: 100vh; display: flex; justify-content: center; align-items: center;
        background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.7)), url('assets/background.webp') center/cover no-repeat;
        position: fixed; width: 100%; z-index: 2000;
    }
    .login-box { background: white; padding: 35px; border-radius: 15px; text-align: center; width: 320px; color: #1a202c; }
    .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .login-box button { width: 100%; padding: 12px; background: #38a169; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

      /* --- PRINT PAGE --- */
  @media print {
    /* 1. Itago ang lahat ng hindi kailangan */
    #sidebar, .sidebar, .profile-wrapper, .btn-export, .btn-print {
        display: none !important;
    }

    /* 2. Tanggalin ang malalaking margin sa papel */
    @page {
        margin: 0.5cm !important; /* Pinaliit para mas maraming magkasya */
    }

    /* 3. "Force" to fit in one page */
    html, body {
        height: 99%; /* Iwasan ang pag-overflow sa Page 2 */
        overflow: hidden;
        font-size: 9px !important; /* Pinaliit ang font para sa buong page */
    }

    .content, #cont {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }

    /* 4. Siksikan ang Table Rows */
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        line-height: 1 !important; /* Pinaliit ang space sa pagitan ng lines */
    }

    th, td {
        padding: 3px 5px !important; /* Sobrang nipis na padding */
        border: 1px solid #000 !important;
    }

    /* 5. Title at Header adjustments */
    h1#greet { font-size: 16px !important; margin: 0 !important; }
    .sub-text { font-size: 10px !important; margin-bottom: 10px !important; }
    
    .filter-bar {
        padding: 5px 0 !important;
        margin-bottom: 10px !important;
        border: none !important;
    }
.blink-urgent { animation: blinker 1.5s linear infinite; }
    @keyframes blinker { 50% { opacity: 0.5; } }
    /* Iwasan ang page break sa loob ng table */
    .data-card {
        page-break-inside: avoid !important;
    }
}
</style>
</head>
<body>
<div id="main-app">
        <div id="sidebar">
            <div class="sidebar-brand" onclick="toggleSide()">
    <img src="assets/abnlogo.png" alt="Logo" class="sidebar-logo">
    <span>ABN UTILITIES</span>
</div>
            <div class="search-box" onclick="expandSidebarForSearch()">
    <div class="search-inner">
        <i class="fas fa-search" style="color: #a0aec0;"></i>
        <input type="text" id="sidebarSearch" placeholder="Search parameters..." oninput="handleSidebarSearch()">
    </div>
</div>
            <div style="margin-top: 10px;">
    <div class="nav-item active" onclick="loadDashboard()"><i class="fas fa-th-large"></i> <span>Dashboard</span></div>
    <div class="nav-item" onclick="openGPMCalculator()"><i class="fas fa-calculator"></i> <span>GPM Calculator</span></div>
    <div class="nav-item" onclick="openPowerMonitor()"><i class="fas fa-bolt"></i> <span>Power Consumption</span></div>
    <div class="nav-item" onclick="openChemicals()"><i class="fas fa-flask"></i> <span>Chemicals</span></div>
    <div class="nav-item" onclick="openCoalDelivery()"><i class="fas fa-truck"></i> <span>Coal Delivery</span></div>
    <div class="nav-item" onclick="openCoalDumping()"><i class="fas fa-truck-loading"></i> <span>Coal Dumping</span></div>
    <div class="nav-item" id="nav-users" onclick="loadUserManagement(this)">
    <i class="fas fa-user-shield"></i> <span>Manage Operators</span>
</div>
</div>
</div>

        <div class="profile-wrapper">
            <div class="profile-circle" id="profileBtn"></div>
            <div class="dropdown-menu" id="profileMenu">
                <div class="user-info-header">
                    <p id="pName">User Name</p>
                    <small id="pRole">Role</small>
                </div>
                <div class="dropdown-item" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i> <span>Dark Mode</span>
                </div>
                <div class="dropdown-item">
                    <i class="fas fa-user-cog"></i> <span>Settings</span>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                <div class="dropdown-item" onclick="logout()" style="color: #e53e3e;">
    <i class="fas fa-sign-out-alt"></i> <span>Log Out</span>
</div>
            </div>
        </div>

        <div class="content" id="cont">
    <div style="display: flex; justify-content: center; align-items: center; height: 50vh;">
        <p style="color: #a0aec0;">Initializing system, please wait...</p>
    </div>
</div>
    </div>

    <script>
        // my firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCwtWs9YdZMojl1FwQNXbAF-QRhWCrlWMQ",
            authDomain: "powercon-nutriveb.firebaseapp.com",
            projectId: "powercon-nutriveb",
            storageBucket: "powercon-nutriveb.firebasestorage.app",
            messagingSenderId: "780606101460",
            appId: "1:780606101460:web:ce9b6c7b73bb756a5a6841",
            databaseURL: "https://powercon-nutriveb-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        // my Supabase config
        const SUPABASE_URL = 'https://qbeacrpoyfacgmbzxjcu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZWFjcnBveWZhY2dtYnp4amN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NTM5NTIsImV4cCI6MjA2NDIyOTk1Mn0.6kfxKLJxidW4BcqsMJte61AtzydrTW-1ZJIJytiUBt4';
       const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
     // Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
       // 4. IMPROVED SECURITY CHECK (Para sa index.html lamang)
    (function checkAccess() {
        const role = localStorage.getItem('userRole');
        const name = localStorage.getItem('userName');

        // A. Kung hindi nakalogin (walang name/role), balik sa Login Page
        if (!role || !name) {
            window.location.href = "login.html"; // Palitan mo kung ano ang filename ng login page mo
            return;
        }

        // B. Kung nakalogin pero HINDI supervisor, itapon sa tools.html
        // Ginawa nating .toLowerCase() para kahit "Supervisor" o "supervisor" sa DB, gagana.
        if (role.toLowerCase() !== 'supervisor') {
            alert("Access Denied! Para lamang ito sa mga Supervisor.");
            window.location.href = "tools.html"; 
        }
    })();
function updateSidebarActive(index) {
    const items = document.querySelectorAll('.nav-item');
    items.forEach((item, i) => {
        if (i === index) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}
    async function openGPMCalculator() {
    updateSidebarActive(1);
    const today = new Date().toISOString().split('T')[0];
    const content = document.getElementById('cont');

    content.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h1 id="greet" style="font-size: 1.2rem;">GPM & Deepwell Monitoring</h1>
            <p class="sub-text" style="margin:0;">System logs for Flow Rate, Pump Status, and Frequencies.</p>
        </div>

        <div class="filter-bar" style="flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.85rem; color: #4a5568; font-weight: 600;">Date:</span>
                <input type="date" id="gpmDateFilter" value="${today}" onchange="fetchGPMLogs()" 
                       style="padding: 6px 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: inherit;">
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.85rem; color: #4a5568; font-weight: 600;">Shift:</span>
                <select id="shiftFilter" onchange="fetchGPMLogs()" 
                        style="padding: 6px 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: inherit; background: white;">
                    <option value="ALL">All Shifts</option>
                    <option value="Morning">Dayshift (Morning)</option>
                    <option value="Nigth">Nightshift (Nigth)</option> 
                </select>
            </div>

            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <span class="total-badge" id="dailyAvgGPM">Logs: 0 | Latest: 0.00 GPM</span>
            </div>
        </div>

        <div class="data-card" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>GPM</th>
                        <th>CWS Status</th>
                        <th>Deepwell 9</th>
                        <th>Deepwell 10</th>
                        <th style="min-width: 150px;">Operator & Action</th>
                    </tr>
                </thead>
                <tbody id="gpmTableBody">
                    <tr><td colspan="6" style="text-align:center; padding: 40px;">Fetching logs...</td></tr>
                </tbody>
            </table>
        </div>
    `;

    fetchGPMLogs();
}
      async function fetchGPMLogs() {
    const tbody = document.getElementById('gpmTableBody');
    const badgeDisplay = document.getElementById('dailyAvgGPM');
    
    const selectedDate = document.getElementById('gpmDateFilter').value;
    const selectedShift = document.getElementById('shiftFilter').value;

    if (!tbody) return;

    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding: 40px;'>Filtering data...</td></tr>";

    // Gawing local time ang start at end para match sa database query
    const startOfDay = `${selectedDate}T00:00:00.000Z`;
    const endOfDay = `${selectedDate}T23:59:59.999Z`;

    let query = supabaseClient
        .from('gpm_readings')
        .select('*')
        .gte('created_at', startOfDay)
        .lte('created_at', endOfDay);

    if (selectedShift !== "ALL") {
        query = query.eq('shift', selectedShift);
    }

    const { data, error } = await query.order('created_at', { ascending: false });

    if (error) {
        tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
        return;
    }

    if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 30px; color: #a0aec0;">No records found.</td></tr>`;
        badgeDisplay.innerText = "No Data";
        badgeDisplay.style.background = "#cbd5e0"; 
        return;
    }

    let rows = "";
    data.forEach(log => {
        const time = new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const gpmVal = parseFloat(log.gpm).toFixed(2);

        const dw9Status = log.deepwell9_active 
            ? `<span style="color:#48bb78;">‚óè ON</span> <small>${log.deepwell9_frequency}Hz</small>` 
            : `<span style="color:#a0aec0;">‚óã OFF</span>`;
            
        const dw10Status = log.deepwell10_active 
            ? `<span style="color:#48bb78;">‚óè ON</span> <small>${log.deepwell10_frequency}Hz</small>` 
            : `<span style="color:#a0aec0;">‚óã OFF</span>`;

        // DITO ANG POSIBLENG ERROR: Siguraduhin na malinis ang pagkaka-copy nito
        rows += `
            <tr>
                <td><b>${time}</b></td>
                <td class="text-blue">${gpmVal}</td>
                <td><small>${log.cws_status}</small></td>
                <td>${dw9Status}</td>
                <td>${dw10Status}</td>
                <td>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <b>${log.operator}</b><br>
                            <small style="color:#718096;">${log.shift}</small>
                        </div>
               <button onclick="deleteGPMLog('${log.id}', event)" 
        style="background: none; border: none; color: #e53e3e; cursor: pointer; padding: 5px 10px;">
    <i class="fas fa-trash-alt"></i>
</button>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = rows;

    const totalCount = data.length;
    const latestGPM = parseFloat(data[0].gpm).toFixed(2);
    
    badgeDisplay.innerHTML = `LOGS: ${totalCount} | LATEST: ${latestGPM} GPM`;
    badgeDisplay.style.background = (parseFloat(latestGPM) < 100) ? "#e53e3e" : "#38a169";
}
        async function deleteGPMLog(logId, e) {
    if (!logId || logId === 'undefined') {
        alert("Error: Missing ID!");
        return;
    }

    const confirmDelete = confirm("Sigurado ka bang buburahin ang record na ito?");
    if (!confirmDelete) return;

    try {
        // 1. Burahin sa Supabase
        const { data, error, status } = await supabaseClient
            .from('gpm_readings')
            .delete()
            .eq('id', logId);

        if (error) throw error;

        // Debugging: 204 means success delete sa Supabase
        console.log("Supabase Status:", status);

        // 2. SUCCESS! Burahin agad sa mata mo (UI)
        const row = e.target.closest('tr');
        if (row) {
            row.style.transition = "0.3s";
            row.style.opacity = "0";
            row.style.background = "#fff5f5";
            setTimeout(() => row.remove(), 300);
        }

        alert("Record deleted permanently!");

    } catch (err) {
        console.error("Delete Failed:", err);
        alert("Failed to delete: " + err.message);
        
        // Pag nag-error, i-refresh ang logs para bumalik 'yung UI sa tama
        fetchGPMLogs();
    }
}
function openPowerMonitor() {
    updateSidebarActive(2);
    const today = new Date().toISOString().split('T')[0];
    const content = document.getElementById('cont');

    content.innerHTML = `
    <div style="margin-bottom: 20px;">
        <h1 id="greet" style="font-size: 1.2rem;">Power Consumption</h1>
        <p class="sub-text" style="margin:0;">Live utility tracking and historical logs.</p>
    </div>

    <div class="filter-bar" style="display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 15px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border-color); margin-bottom: 20px;">
        
        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.9rem; color: var(--text-sub); font-weight: 600;">Filter Date:</span>
                <input type="date" id="dateFilter" value="${today}" onchange="fetchPowerData(this.value)" 
                       style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: inherit;">
            </div>
            <span id="opBadge" class="info-badge">Operator: ---</span>
            <span id="grandTotalDisplay" style="font-weight: bold; font-size: 0.95rem;">Total: 0.00 kWh</span>
        </div>

        <div style="display: flex; gap: 8px;">
            <button onclick="exportPowerToExcel()" class="btn-export" style="padding: 8px 12px; font-size: 0.8rem; background: #2f855a; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
           <button onclick="const d = document.querySelector('input[type=date]').value; window.open('logsheet.html?date=' + d, '_blank')" 
        class="btn-print" 
        style="padding: 8px 12px; font-size: 0.8rem; background: #2b6cb0; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
    <i class="fas fa-print"></i> Print Logsheet
</button>
        </div>
    </div>

    <div class="data-card">
        <table>
            <thead>
                <tr>
                    <th>Equipment Name</th>
                    <th>Previous (kWh)</th>
                    <th>Current (kWh)</th>
                    <th>Usage (kWh)</th>
                </tr>
            </thead>
            <tbody id="powerBody">
                <tr><td colspan="4">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
`;
    
    fetchPowerData(today);
}
        function exportPowerToExcel() {
    const table = document.querySelector(".data-card table");
    const dateSelected = document.getElementById('dateFilter').value;
    const operator = document.getElementById('opBadge').innerText;
    const total = document.getElementById('grandTotalDisplay').innerText;

    // Convert table to worksheet
    const wb = XLSX.utils.table_to_book(table, { sheet: "Power Consumption" });
    
    // Download file
    XLSX.writeFile(wb, `Power_Report_${dateSelected}.xlsx`);
}

function fetchPowerData(selectedDate) {
    const tbody = document.getElementById('powerBody');
    const opBadge = document.getElementById('opBadge');
    const grandTotalDisplay = document.getElementById('grandTotalDisplay');
    
    tbody.innerHTML = "<tr><td colspan='4'>Loading data...</td></tr>";

    database.ref('readings/' + selectedDate).on('value', (snapshot) => {
        const data = snapshot.val();
        if(!data) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No readings found for this date.</td></tr>";
            opBadge.innerText = "Operator: No Data";
            grandTotalDisplay.innerText = "Total: 0.00 kWh";
            return;
        }

        let rows = "";
        let totalSum = 0;

        Object.keys(data).forEach(key => {
            if(key !== 'metadata') {
                const item = data[key];
                const usage = parseFloat(item.usage) || 0;
                totalSum += usage;
                rows += `
                    <tr>
                        <td><b>${item.name}</b></td>
                        <td>${item.prev}</td>
                        <td>${item.curr}</td>
                        <td class="text-blue">${usage.toFixed(2)}</td>
                    </tr>
                `;
            }
        });

        tbody.innerHTML = rows;
        opBadge.innerText = "Operator: " + (data.metadata ? data.metadata.operator : "Unknown");
        grandTotalDisplay.innerText = "Total: " + totalSum.toFixed(2) + " kWh";
    });
}
        function openChemicals() {
    updateSidebarActive(3);
    const content = document.getElementById('cont');
    content.innerHTML = `
        <div class="header-flex">
            <h1>Chemicals Inventory</h1>
            <p class="sub-text">Monitor stock levels and consumption of plant chemicals.</p>
        </div>
        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: #9f7aea;">
                <h4>PAC Stock</h4>
                <div class="value" id="pacStock">0 bags</div>
            </div>
            <div class="stat-card" style="border-left-color: #ed64a6;">
                <h4>Polymer Stock</h4>
                <div class="value" id="polyStock">0 liters</div>
            </div>
        </div>
        <div class="data-card">
            <p style="text-align:center; color:#a0aec0;">Detailed chemical logs coming soon...</p>
        </div>
    `;
    // Fetch logic from Firebase
    database.ref('inventory/chemicals').on('value', (snap) => {
        const data = snap.val() || { pac: 0, poly: 0 };
        document.getElementById('pacStock').innerText = data.pac + " bags";
        document.getElementById('polyStock').innerText = data.poly + " liters";
    });
}
       // --- COAL YARD MONITORING LOGIC ---
async function openCoalDelivery() {
    const cont = document.getElementById('cont');
    
    cont.innerHTML = `
    <div class="coal-container" style="padding: 20px; font-family: 'Segoe UI', sans-serif; color: #2d3748;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #2d3748; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-industry"></i> Coal Yard Live Status
            </h2>
            <div id="last-update" style="font-size: 0.8rem; color: #a0aec0; background: #fff; padding: 5px 12px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                Syncing...
            </div>
        </div>

        <div id="coal-summary"></div>

        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
             <div style="display: flex; gap: 15px; background: #fff; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); align-items: center;">
                <span style="font-weight: bold; font-size: 0.8rem; color: #718096;">FILTER:</span>
                <label style="cursor:pointer; font-size: 0.85rem;"><input type="checkbox" class="yard-filter" value="vacant" checked onchange="renderGridOnly()"> Vacant</label>
                <label style="cursor:pointer; font-size: 0.85rem;"><input type="checkbox" class="yard-filter" value="standby" checked onchange="renderGridOnly()"> Standby</label>
                <label style="cursor:pointer; font-size: 0.85rem;"><input type="checkbox" class="yard-filter" value="in use" checked onchange="renderGridOnly()"> In Use</label>
            </div>
        </div>

        <div id="prio-banner" style="background: #edf2f7; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; border: 2px solid #e2e8f0; transition: all 0.3s;">
            <small style="text-transform: uppercase; color: #718096; letter-spacing: 1px; font-weight: bold;">Priority for Consumption</small>
            <div id="prio-text" style="font-size: 1.5rem; font-weight: 900; margin-top: 5px; color: #2d3748;">Checking...</div>
        </div>

        <div id="yard-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;"></div>

        <div style="margin-top: 50px; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-top: 5px solid #2d3748;">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h3 style="margin: 0; font-size: 1.3rem; color: #1a202c; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-book" style="color: #4a5568;"></i> Master Logbook Archives
                    </h3>
                    <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #718096;">Search historical delivery and consumption records by date.</p>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: flex-end; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <div>
                        <label style="display:block; font-size:0.65rem; color:#4a5568; font-weight:bold; margin-bottom:4px;">FROM DATE:</label>
                        <input type="date" id="dateFrom" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.65rem; color:#4a5568; font-weight:bold; margin-bottom:4px;">TO DATE:</label>
                        <input type="date" id="dateTo" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 0.9rem;">
                    </div>
                    <button onclick="fetchHistoryByDate()" style="background: #2d3748; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s;">
                        <i class="fas fa-search"></i> SEARCH
                    </button>
                    <button onclick="window.print()" style="background: white; color: #2d3748; border: 1px solid #cbd5e0; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>

            <div id="history-list" style="min-height: 200px; border: 1px dashed #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; color: #a0aec0;">
                    <i class="far fa-calendar-alt" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Select a date range and click Search to load logbook data.</p>
                </div>
            </div>
        </div>
    </div>
    `;

    // Initialize the live grid sync
    syncCoalData();
    
    // Auto-refresh every 30 seconds (GRID ONLY)
    if (window.coalSyncInterval) clearInterval(window.coalSyncInterval);
    window.coalSyncInterval = setInterval(syncCoalData, 30000); 
}
        async function fetchHistoryByDate() {
    const from = document.getElementById('dateFrom').value;
    const to = document.getElementById('dateTo').value;
    const histDiv = document.getElementById('history-list');

    if (!from || !to) {
        alert("Pili muna ng Date Range, boss!");
        return;
    }

    // Loading state na may icon
    histDiv.innerHTML = `
        <div style="text-align:center; padding:40px; color:#718096;">
            <i class="fas fa-spinner fa-spin fa-2x"></i><br>
            <p style="margin-top:10px;">Searching Archives from ${from} to ${to}...</p>
        </div>`;

    // Fetch lahat ng columns (CTP, OR, Plate, etc.)
    const { data: records, error } = await supabaseClient
        .from('delivery_logs')
        .select('*') 
        .gte('date_arrived', from) 
        .lte('date_arrived', to)
        .order('date_arrived', { ascending: false })
        .order('time_arrived', { ascending: false });

    if (error) {
        console.error(error);
        histDiv.innerHTML = "<p style='color:red; text-align:center;'>Error loading data. Please check connection.</p>";
        return;
    }

    if (records.length === 0) {
        histDiv.innerHTML = `
            <div style="text-align:center; padding:40px; color:#e53e3e;">
                <i class="fas fa-search-minus fa-2x"></i><br>
                <p style="margin-top:10px;">No delivery logs found for these dates.</p>
            </div>`;
        return;
    }

    // Tawagin ang renderer para sa malapad na table
    renderHistoryTable(records);
}

// --- CONFIGURATION ---
let currentYardData = {}; 

// 1. Helper: Gaano na katagal "In Use"
function calculateElapsed(startDate, startTime) {
    if (!startDate || !startTime || startDate === '--') return "";
    const start = new Date(`${startDate}T${startTime}`);
    const now = new Date();
    const diffMs = now - start;
    if (diffMs < 0) return "Starting...";
    
    const hrs = Math.floor(diffMs / 3600000);
    const mins = Math.floor((diffMs % 3600000) / 60000);
    return `${hrs}h ${mins}m running`;
}

function getShift(timeString) {
    if (!timeString || timeString === '--') return "";
    const hour = parseInt(timeString.split(':')[0]);
    return (hour >= 6 && hour < 18) ? "DS" : "NS";
}

async function syncCoalData() {
    // 1. Fetch Data from Supabase
    const { data: logs, error } = await supabaseClient
        .from('delivery_logs')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) return console.error('Supabase Error:', error);
    if (!logs) return;

    let totalStandbyKg = 0;
    let totalInUseKg = 0;
    const standbyLogs = [];
    
    // 2. Initialize 9 Yards (Laging back to default para malinis ang simula)
    for(let i=1; i<=9; i++) {
        currentYardData[i] = { 
            status: 'vacant', 
            supplier: 'Empty', 
            kg: 0, 
            dr_no: '--',      // Idagdag ito
            ctp_no: '--',      // Idagdag ito
            date: '--', 
            time: '--', 
            shift: '', 
            operator: 'None', 
            startedDate: '', 
            startedTime: '' 
        };
    }

    // 3. Process Logs para sa Live Grid
    const processed = new Set();
    logs.forEach(log => {
        const y = String(log.coal_yard_no);
        if (!processed.has(y)) {
            let d = '--', t = '--', op = log.operator_name || 'System';
            
            if (log.remarks === 'in use') {
                d = log.date_in_use; t = log.time_in_use;
                totalInUseKg += (Number(log.coal_kg) || 0);
            } else if (log.remarks === 'standby') {
                d = log.date_arrived; t = log.time_arrived;
                totalStandbyKg += (Number(log.coal_kg) || 0);
                standbyLogs.push(log);
            } else {
                d = log.date_used_up; t = log.time_used_up;
            }

            currentYardData[y] = {
                status: log.remarks === 'used up' ? 'vacant' : log.remarks,
                supplier: log.supplier_name,
                kg: Number(log.coal_kg) || 0,
                dr_no: log.dr_no, 
                ctp_no: log.ctp_no || '--',
                date: d,
                time: t,
                shift: getShift(t),
                operator: op,
                startedDate: log.date_in_use,
                startedTime: log.time_in_use
            };
            processed.add(y);
        }
    });

    // 4. Update UI (Summary, Grid, at Priority Banner)
    if (typeof updateSummaryUI === "function") updateSummaryUI(totalStandbyKg, totalInUseKg);
    if (typeof renderGridOnly === "function") renderGridOnly();
    if (typeof updatePriorityBanner === "function") updatePriorityBanner(currentYardData, standbyLogs);
    
    // DASHBOARD SIDEBAR UPDATE (Yung bagong request mo)
    if (typeof updateDashboardSidebar === "function") {
        updateDashboardSidebar();
    }

    // 5. SMART TABLE UPDATE (Dito ang anti-gulo logic)
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const histDiv = document.getElementById('history-list');

    // MGA CONDITIONS PARA HINDI MAG-REFRESH ANG TABLE:
    const hasDateInput = (dateFromInput && dateFromInput.value) || (dateToInput && dateToInput.value);
    const isSearching = histDiv && (histDiv.innerHTML.includes("Searching records") || histDiv.innerHTML.includes("Grand Total:"));

    if (!hasDateInput && !isSearching) {
        // DEFAULT VIEW: FIFO List (Standby at In Use lang)
        const activeFIFO = logs.filter(l => l.remarks === 'standby' || l.remarks === 'in use')
            .sort((a, b) => {
                const dateA = new Date(`${a.date_arrived}T${a.time_arrived}`);
                const dateB = new Date(`${b.date_arrived}T${b.time_arrived}`);
                return dateA - dateB;
            });
        
        if (typeof renderHistoryTable === "function") {
            renderHistoryTable(activeFIFO);
        }
    }

    // 6. Last Sync Timestamp
    if(document.getElementById('last-update')) {
        document.getElementById('last-update').innerText = "Last Sync: " + new Date().toLocaleTimeString();
    }
} // <--- DITO DAPAT NAG-EEND ANG FUNCTION

function renderGridOnly() {
    const grid = document.getElementById('yard-grid');
    if (!grid) return;

    const selectedFilters = Array.from(document.querySelectorAll('.yard-filter:checked')).map(cb => cb.value);
    
    grid.innerHTML = '';
    for(let i=1; i<=9; i++) {
        const data = currentYardData[i];
        if (!selectedFilters.includes(data.status)) continue;

        // Color coding: Blue (Standby), Yellow (In Use), Green (Vacant)
        let bgColor = data.status === 'standby' ? '#3182ce' : (data.status === 'in use' ? '#d69e2e' : '#48bb78');
        const isVacant = data.status === 'vacant';

        grid.innerHTML += `
            <div style="background: ${bgColor}; padding: 18px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-bottom: 5px solid rgba(0,0,0,0.2); min-height: 180px; position: relative; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;">
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; z-index: 2;">
                    <div>
                        <small style="font-weight: bold; opacity: 0.8;">YARD</small>
                        <div style="font-size: 2.8rem; font-weight: 900; line-height: 1;">${i}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.2rem; font-weight: bold;">${!isVacant && data.kg > 0 ? data.kg.toLocaleString() + ' kg' : '--'}</div>
                        <div style="font-size: 0.65rem; background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 5px; text-transform: uppercase; font-weight: bold;">
                            ${data.status} ${!isVacant ? '| ' + data.shift : ''}
                        </div>
                        ${data.status === 'in use' ? `
                            <div style="font-size: 0.65rem; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; margin-top: 5px;">
                                <i class="fas fa-stopwatch"></i> ${calculateElapsed(data.startedDate, data.startedTime)}
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${isVacant ? `
                    <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center; opacity: 0.4; pointer-events: none;">
                        <div style="border: 2px solid white; padding: 5px 15px; border-radius: 8px; font-weight: 900; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; transform: rotate(-5deg);">
                            Ready for Delivery
                        </div>
                    </div>
                ` : ''}

                <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; z-index: 2; ${isVacant ? 'display: none;' : ''}">
                    <div style="font-size: 0.9rem; font-weight: 800; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${data.supplier}
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="far fa-clock" style="font-size: 0.8rem;"></i>
                        <div style="line-height: 1.1;">
                            <div style="font-size: 0.75rem; font-weight: bold; opacity: 0.9;">${data.date}</div>
                            <div style="font-size: 1.1rem; font-weight: 900;">${data.time}</div>
                        </div>
                    </div>

                    <div style="margin-top: 8px; font-size: 0.6rem; opacity: 0.8;">
                        <i class="fas fa-user-edit"></i> Op: ${data.operator}
                    </div>
                </div>

            </div>
        `;
    }
}
// 2. New Function para sa History Table sa baba
function renderHistoryTable(history) {
    const histDiv = document.getElementById('history-list');
    if (!histDiv) return;

    // 1. Calculations
    const grandTotalKg = history.reduce((sum, item) => sum + (Number(item.coal_kg) || 0), 0);
    const totalRecords = history.length;

    let tableHtml = `
        <div style="overflow-x: auto;">
            <table style="width:100%; border-collapse:collapse; background:white; font-size:0.75rem; min-width:1200px; border:1px solid #e2e8f0;">
                <thead style="background:#2d3748; color:white; text-transform:uppercase; letter-spacing:0.5px;">
                    <tr>
                        <th style="padding:12px; border:1px solid #4a5568;">Yard / Operator</th>
                        <th style="padding:12px; border:1px solid #4a5568;">Supplier / DR NO.</th>
                        <th style="padding:12px; border:1px solid #4a5568;">Arrival Info</th>
                        <th style="padding:12px; border:1px solid #4a5568; background:#744210;">In Use (Start)</th>
                        <th style="padding:12px; border:1px solid #4a5568; background:#22543d;">Used Up (Finish)</th>
                        <th style="padding:12px; border:1px solid #4a5568; background:#4a5568;">Consumed Time</th> <th style="padding:12px; border:1px solid #4a5568;">Gross Weight</th>
                    </tr>
                </thead>
                <tbody>
    `;

    history.forEach(h => {
        // --- 2. LOGIC PARA SA CONSUMED TIME ---
        let consumedDisplay = "--";
        if (h.date_in_use && h.date_used_up) {
            const start = new Date(`${h.date_in_use}T${h.time_in_use}`);
            const end = new Date(`${h.date_used_up}T${h.time_used_up}`);
            const diffMs = end - start;

            if (diffMs > 0) {
                const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                consumedDisplay = days > 0 
                    ? `${days}d ${hours}h ${mins}m` 
                    : `${hours}h ${mins}m`;
            }
        }

       tableHtml += `
            <tr style="border-bottom:1px solid #edf2f7; transition:0.2s;" onmouseover="this.style.backgroundColor='#f7fafc'" onmouseout="this.style.backgroundColor='transparent'">
                <td style="padding:12px; text-align:center; border:1px solid #edf2f7; background:#f8fafc;">
                    <div style="font-weight:900; font-size:1.1rem; color:#2d3748;">${h.coal_yard_no}</div>
                    <div style="font-size:0.6rem; color:#718096; text-transform:uppercase;">
                        <i class="fas fa-user-edit"></i> ${h.operator_name || '---'}
                    </div>
                </td>
                
                <td style="padding:12px; border:1px solid #edf2f7;">
                    <div style="font-weight:bold; color:#2d3748; margin-bottom: 4px;">${h.supplier_name || '---'}</div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <span style="color:#2b6cb0; font-size:0.7rem; font-weight:bold;">
                            <i class="fas fa-file-invoice" style="width:12px;"></i> DR: ${h.dr_no || '--'}
                        </span>
                        <span style="color:#b7791f; font-size:0.7rem; font-weight:bold;">
                            <i class="fas fa-barcode" style="width:12px;"></i> CTP: ${h.ctp_no || '--'}
                        </span>
                    </div>
                </td>

                <td style="padding:12px; border:1px solid #edf2f7;">
                    ${h.date_arrived}<br><small style="color:#a0aec0;">${h.time_arrived}</small>
                </td>
                <td style="padding:12px; border:1px solid #edf2f7; background:#fffaf0;">
                    <b>${h.date_in_use || '--'}</b><br><small>${h.time_in_use || '--'}</small>
                </td>
                <td style="padding:12px; border:1px solid #edf2f7; background:#f0fff4;">
                    <b>${h.date_used_up || '--'}</b><br><small>${h.time_used_up || '--'}</small>
                </td>
                <td style="padding:12px; border:1px solid #edf2f7; text-align:center; font-weight:bold; color:#4a5568; background:#f7fafc;">
                    ${consumedDisplay}
                </td>
                <td style="padding:12px; border:1px solid #edf2f7; font-weight:bold; color:#2d3748; text-align:right;">
                    ${(Number(h.coal_kg) || 0).toLocaleString()} kg
                </td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
                <tfoot style="background: #edf2f7; border-top: 2px solid #2d3748;">
                    <tr>
                        <td colspan="3" style="padding: 15px; font-weight: bold;">Records: ${totalRecords}</td>
                        <td colspan="3" style="padding: 15px; text-align: right; font-weight: bold; text-transform: uppercase;">Grand Total:</td>
                        <td style="padding: 15px; text-align: right; font-weight: 900; color: #2b6cb0; font-size: 1rem; border-left: 2px solid #cbd5e0;">
                            ${grandTotalKg.toLocaleString()} kg
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;

    histDiv.innerHTML = tableHtml;
}
// B. Para sa Priority Banner (FIFO at Yard 9 Rule)
function updatePriorityBanner(yardData, standbyLogs) {
    let prioText = "All Yards Clear";
    let isUrgent = false;

    if (yardData["9"] && (yardData["9"].status === 'standby' || yardData["9"].status === 'in use')) {
        prioText = `üö® PRIO: YARD 9 (${yardData["9"].supplier})`;
        isUrgent = true;
    } else if (standbyLogs.length > 0) {
        const oldest = [...standbyLogs].sort((a, b) => new Date(`${a.date_arrived}T${a.time_arrived}`) - new Date(`${b.date_arrived}T${b.time_arrived}`))[0];
        prioText = `NEXT PRIO: YARD ${oldest.coal_yard_no} (${oldest.supplier_name})`;
    }

    const banner = document.getElementById('prio-banner');
    const prioTextEl = document.getElementById('prio-text');
    if (prioTextEl) prioTextEl.innerText = prioText;
    if (banner) {
        isUrgent ? banner.style.background = "#fff5f5" : banner.style.background = "#edf2f7";
        isUrgent ? banner.style.borderColor = "#f56565" : banner.style.borderColor = "#e2e8f0";
    }
}
        function updateSummaryUI(standby, inuse) {
    const summary = document.getElementById('coal-summary');
    if (!summary) return;
    summary.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: #ebf8ff; border-left: 6px solid #3182ce; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <small style="color: #2b6cb0; font-weight: bold; text-transform: uppercase; font-size: 0.7rem;">Total Standby Inventory</small>
                <div style="font-size: 1.5rem; font-weight: 900; color: #2c5282;">${standby.toLocaleString()} <span style="font-size: 0.8rem;">kg</span></div>
            </div>
            <div style="background: #fffaf0; border-left: 6px solid #dd6b20; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <small style="color: #9c4221; font-weight: bold; text-transform: uppercase; font-size: 0.7rem;">Current Consumption (In Use)</small>
                <div style="font-size: 1.5rem; font-weight: 900; color: #7b341e;">${inuse.toLocaleString()} <span style="font-size: 0.8rem;">kg</span></div>
            </div>
        </div>
    `;
}
        const yards = ["CY1", "CY2", "CY3", "CY4", "CY5", "CY6", "CY7", "CY8", "CY9"];
        async function openCoalDumping() {
    updateSidebarActive(5);
    const content = document.getElementById('cont');
    
    // Initial Layout with Stats and Tools
    content.innerHTML = `
        <div class="mb-6">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-black text-slate-800">Coal Dumping (Consumption)</h1>
            </div>
            <div id="syncIndicator" class="text-[9px] font-bold text-emerald-500 uppercase italic mt-1 tracking-wider opacity-80">
                <span class="animate-pulse text-[12px]">‚óè</span> Live Cloud Connection
            </div>
        </div>
<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="text-[9px] font-black text-slate-400 uppercase mb-1">Estimated (Today)</h4>
        <div id="todayTotalKg" class="text-lg font-black text-slate-800">---</div>
        <div class="text-[7px] font-bold text-slate-400 uppercase italic">Rate: 200kg/bkt</div>
    </div>
    
    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm border-l-4 border-l-emerald-500">
        <h4 class="text-[9px] font-black text-emerald-600 uppercase mb-1">Actual (Today)</h4>
        <div id="todayActualKg" class="text-lg font-black text-emerald-600">---</div>
        <div id="actualBucketRate" class="text-[7px] font-bold text-emerald-500 uppercase italic">Rate: ---</div>
    </div>

    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm border-l-4 border-l-blue-500">
        <h4 class="text-[9px] font-black text-blue-600 uppercase mb-1">Remaining Balance</h4>
        <div id="remainingBalanceDisplay" class="text-lg font-black text-blue-600">---</div>
        <div class="text-[7px] font-bold text-slate-400 uppercase italic">Stock Left</div>
    </div>

    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="text-[9px] font-black text-indigo-600 uppercase mb-1">Active Supplier</h4>
        <div id="supplierDisplay" class="text-[10px] font-black text-slate-800 truncate">---</div>
        <div id="grossWeightDisplay" class="text-[7px] font-bold text-slate-400 uppercase">Net: ---</div>
    </div>

    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="text-[9px] font-black text-orange-500 uppercase mb-1">Variance %</h4>
        <div id="varianceDisplay" class="text-lg font-black text-orange-500">---</div>
    </div>

    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="text-[9px] font-black text-slate-400 uppercase mb-1">Yard Source</h4>
        <div id="activeYardDisplay" class="text-lg font-black text-slate-800">---</div>
    </div>
</div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-xl">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-900/50 text-lg">‚öñÔ∏è</div>
                        <div>
                            <h3 class="text-[11px] font-black uppercase tracking-[0.2em]">Yard Finalization</h3>
                            <p class="text-[8px] font-bold text-slate-400 uppercase">Input actual weight for recompute</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[8px] font-black uppercase ml-2 text-slate-500">Select Yard to Close</label>
<select id="finalizeYardSelect" onchange="refreshMasterLog()" class="w-full bg-slate-800 border-none rounded-2xl p-4 text-[12px] font-black outline-none focus:ring-2 focus:ring-orange-500 mt-1">
    ${yards.map(y => `<option value="${y}">${y}</option>`).join('')}
</select>
                        </div>
                        <div>
                            <label class="text-[8px] font-black uppercase ml-2 text-slate-500">Actual Total Weight (KG)</label>
                            <input id="actualWeightInput" type="number" placeholder="0.00" class="w-full bg-slate-800 border-none rounded-2xl p-4 text-[12px] font-black outline-none focus:ring-2 focus:ring-orange-500 mt-1 text-orange-400">
                        </div>
                        <button onclick="triggerFinalize()" class="w-full py-4 bg-orange-500 hover:bg-orange-600 rounded-2xl font-black text-[11px] uppercase tracking-widest transition-all active:scale-95 shadow-lg shadow-orange-950 mt-2">
                            Finalize & Recompute
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-[11px] font-black uppercase tracking-widest text-slate-800">Consumption Master Log</h3>
                        <div class="flex gap-2">
                            <input type="date" id="archiveDateFilter" onchange="refreshMasterLog()" class="text-[10px] font-black bg-slate-50 border-none rounded-lg p-2 outline-none">
                            <select id="shiftFilter" onchange="refreshMasterLog()" class="text-[10px] font-black bg-slate-50 border-none rounded-lg p-2 outline-none">
                            <option value="DAY">DAY SHIFT</option>
                            <option value="NIGHT">NIGHT SHIFT</option>
                            <option value="ALL">FULL 24 HOURS</option> </select>
                        </div>
                    </div>
                    <div id="masterLogContent" class="overflow-x-auto">
                        <p class="text-center p-10 text-[10px] font-black uppercase text-slate-300 italic">Select date to view logs...</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Set default date and load
    document.getElementById('archiveDateFilter').valueAsDate = new Date();
    refreshMasterLog();
}
     async function refreshMasterLog() {
    const logCont = document.getElementById('masterLogContent');
    const date = document.getElementById('archiveDateFilter').value;
    const currentYard = document.getElementById('finalizeYardSelect').value;

    logCont.innerHTML = '<p class="text-center p-10 text-[10px] font-black text-slate-400 italic animate-pulse">Fetching Records...</p>';

    try {
        // KUKUHA LANG NG DATA PARA SA SPECIFIC NA PETSA NA 'TO (00:00 - 23:59)
        const { data: logs, error } = await supabaseClient
            .from('daily_bucket_logs')
            .select('*')
            .eq('log_date', date)
            .order('time_slot', { ascending: true });

        if (error) throw error;

        // DITO: Tinanggal na natin ang Shift Filter logic (hr >= 18 || hr < 6)
        // Lahat ng makuha sa database para sa petsang 'date' ay isasama sa computation.
        const filtered = logs; 

        let totalBkt = 0;
        let totalEstKg = 0;
        let totalActKg = 0;

        // Build Table HTML
        let html = `
            <table class="w-full text-[10px] text-left">
                <thead>
                    <tr class="text-slate-400 border-b border-slate-50">
                        <th class="p-3 uppercase">Time</th>
                        <th class="p-3 uppercase text-center">Boiler</th>
                        <th class="p-3 uppercase text-center">Buckets</th>
                        <th class="p-3 uppercase text-right">Estimate (kg)</th>
                        <th class="p-3 uppercase text-right text-emerald-600">Actual (kg)</th>
                        <th class="p-3 uppercase text-right font-black">Yard</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    ${filtered.map(l => {
                        totalBkt += l.buckets_used || 0;
                        totalEstKg += (l.kg_estimated || 0);
                        totalActKg += (l.kg_actual || 0);
                        return `
                        <tr class="${l.is_finalized ? 'bg-emerald-50/30' : ''}">
                            <td class="p-3 font-bold text-slate-700">${l.time_slot}</td>
                            <td class="p-3 text-center"><span class="px-2 py-0.5 rounded bg-slate-100 font-black">${l.boiler}</span></td>
                            <td class="p-3 text-center font-black">${l.buckets_used}</td>
                            <td class="p-3 text-right text-slate-400 italic">${(l.kg_estimated || 0).toLocaleString()}</td>
                            <td class="p-3 text-right font-black text-emerald-600">${l.is_finalized ? (l.kg_actual || 0).toLocaleString() : '---'}</td>
                            <td class="p-3 text-right font-black text-slate-700">${l.yard_no}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
                <tfoot class="bg-slate-900 text-white font-black">
                    <tr>
                        <td colspan="2" class="p-3 text-right uppercase text-[8px]">Total (24hrs):</td>
                        <td class="p-3 text-center text-orange-400">${totalBkt}</td>
                        <td class="p-3 text-right">${totalEstKg.toLocaleString()}</td>
                        <td class="p-3 text-right text-emerald-400">${totalActKg > 0 ? totalActKg.toLocaleString() : '---'}</td>
                        <td class="p-3"></td>
                    </tr>
                </tfoot>
            </table>`;

        logCont.innerHTML = filtered.length > 0 ? html : '<p class="text-center p-10 text-[10px] font-black text-slate-300 italic">No records found for this calendar day.</p>';

        // UPDATE STATS CARDS
        document.getElementById('todayTotalKg').innerText = totalEstKg.toLocaleString() + " KG";
        
        const actDisplay = document.getElementById('todayActualKg');
        const varDisplay = document.getElementById('varianceDisplay');

        if (totalActKg > 0) {
            actDisplay.innerText = totalActKg.toLocaleString() + " KG";
            const variance = ((totalActKg - totalEstKg) / totalEstKg) * 100;
            varDisplay.innerText = `${variance > 0 ? '+' : ''}${variance.toFixed(2)}%`;
            varDisplay.className = `text-lg font-black ${variance >= 0 ? 'text-emerald-500' : 'text-red-500'}`;
        } else {
            actDisplay.innerText = "PENDING";
            varDisplay.innerText = "---";
        }

        // UPDATE YARD DISPLAY
        const yardsInLog = [...new Set(filtered.map(l => l.yard_no))];
        document.getElementById('activeYardDisplay').innerText = yardsInLog.length > 0 ? yardsInLog.join(' / ') : "---";

        // UPDATE INVENTORY
        await updateInventoryStats(currentYard);

    } catch (err) {
        console.error(err);
        logCont.innerHTML = `<p class="p-5 text-red-500 text-[10px]">Error: ${err.message}</p>`;
    }
}

async function updateInventoryStats(currentYard) {
    try {
        // 1. I-convert ang "CY5" papuntang "5" (String format para match sa JSON)
        const yardNumberOnly = currentYard.replace("CY", ""); 

        // 2. Kunin ang delivery na "in use" o "active delivery"
        // base sa pattern niyo, kung hindi 'used up', ito ang active source.
        const { data: delivery, error } = await supabaseClient
            .from('delivery_logs')
            .select('supplier_name, coal_kg, remarks')
            .eq('coal_yard_no', yardNumberOnly) 
            .eq('remarks', 'in use') // Siguraduhin na 'active delivery' ang nilalagay niyo sa remarks
            .is('date_used_up', null)
            .maybeSingle();

        if (error) throw error;

        const supplierDisp = document.getElementById('supplierDisplay');
        const balanceDisp = document.getElementById('remainingBalanceDisplay');
        const grossDisp = document.getElementById('grossWeightDisplay');
        const actualInput = document.getElementById('actualWeightInput');

        if (delivery) {
            // 3. KUNIN LAHAT NG BUCKETS NA HINDI PA FINALIZED (WHOLE YARD LOGIC)
            const { data: buckets } = await supabaseClient
                .from('daily_bucket_logs')
                .select('kg_estimated')
                .eq('yard_no', currentYard) // Sa bucket logs "CY5" ang format
                .eq('is_finalized', false);

            const totalConsumed = buckets.reduce((sum, b) => sum + (parseFloat(b.kg_estimated) || 0), 0);
            const initialNetWeight = parseFloat(delivery.coal_kg) || 0;
            const remainingBalance = initialNetWeight - totalConsumed;

            // 4. DISPLAY SA UI
            if(supplierDisp) supplierDisp.innerText = delivery.supplier_name;
            if(grossDisp) grossDisp.innerText = `NET: ${initialNetWeight.toLocaleString()} KG`;
            
            if(balanceDisp) {
                balanceDisp.innerText = remainingBalance.toLocaleString() + " KG";
                balanceDisp.className = `text-xl font-black ${remainingBalance < 0 ? 'text-red-500' : 'text-blue-600'}`;
            }
            
            // Auto-fill actual input para sa Finalize button
            if(actualInput) actualInput.value = initialNetWeight;

        } else {
            if(supplierDisp) supplierDisp.innerText = "NO ACTIVE DELIVERY";
            if(balanceDisp) balanceDisp.innerText = "---";
            if(grossDisp) grossDisp.innerText = "NET: ---";
            if(actualInput) actualInput.value = "";
        }
    } catch (err) {
        console.error("Inventory Link Error:", err.message);
    }
}
     async function triggerFinalize() {
    const selectedYard = document.getElementById('finalizeYardSelect').value;
    const yardNumberOnly = selectedYard.replace("CY", ""); 
    const actualWeight = parseFloat(document.getElementById('actualWeightInput').value);

    if (!actualWeight || actualWeight <= 0) {
        alert("Boss, paki-input yung Actual Weight.");
        return;
    }

    if (!confirm(`Finalize ${selectedYard}? Ito ay magiging 'used up' na sa record.`)) return;

    try {
        // [Part A] I-update ang Bucket Logs to is_finalized: true para sa Yard na ito
        // Para hindi na sila mabilang sa susunod na delivery
        const { error: bucketError } = await supabaseClient
            .from('daily_bucket_logs')
            .update({ 
                is_finalized: true,
                kg_actual: actualWeight // Opsyonal: i-distribute ang actual weight kung gusto mo
            })
            .eq('yard_no', selectedYard)
            .eq('is_finalized', false);

        if (bucketError) throw bucketError;

        // [Part B] I-update ang Delivery Log to 'used up'
        const { error: deliveryError } = await supabaseClient
            .from('delivery_logs')
            .update({ 
                date_used_up: new Date().toISOString().split('T')[0],
                time_used_up: new Date().toLocaleTimeString('it-IT', { hour12: false }),
                remarks: 'used up'
            })
            .eq('coal_yard_no', yardNumberOnly)
            .eq('remarks', 'in use')
            .is('date_used_up', null);

        if (deliveryError) throw deliveryError;

        alert(`Success! ${selectedYard} closed and marked as used up.`);
        
        // Linisin ang input field at i-refresh ang UI
        document.getElementById('actualWeightInput').value = '';
        refreshMasterLog();
        
    } catch (err) {
        alert("Error during finalization: " + err.message);
    }
}
       function login() {
    const val = document.getElementById('passCode').value;
    if(db[val]) {
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userCode', val);

        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        
        // --- ETO ANG DAGDAG: SET DYNAMIC PROFILE PIC ---
        const profilePath = 'assets/' + db[val].p;
        document.getElementById('profileBtn').style.backgroundImage = `url('${profilePath}')`;
        
        document.getElementById('pName').innerText = db[val].n;
        document.getElementById('pRole').innerText = db[val].r;
        
        loadDashboard(); 
    } else { 
        alert("Access Denied!"); 
    }
}

        // --- NEW PROFILE DROPDOWN SCRIPT ---
        const profileBtn = document.getElementById('profileBtn');
        const profileMenu = document.getElementById('profileMenu');

        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Pigilan ang pag-close agad
            profileMenu.classList.toggle('show');
        });

        // Close dropdown kapag nag-click sa labas
        window.addEventListener('click', () => {
            if (profileMenu.classList.contains('show')) {
                profileMenu.classList.remove('show');
            }
        });

        function togglePassView() {
            const p = document.getElementById('passCode');
            const icon = document.getElementById('togglePass');
            p.type = (p.type === "password") ? "text" : "password";
            icon.classList.toggle('fa-eye-slash');
        }

        function toggleSide() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('cont').classList.toggle('expanded');
        }

        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('collapsed')) {
                    toggleSide();
                }
            });
        });
   function loadDashboard() {
    updateSidebarActive(0);
    const content = document.getElementById('cont');
    
    const userCode = localStorage.getItem('userCode');
    const userName = localStorage.getItem('userName') || "User"; 
    
    const sInput = document.getElementById('sidebarSearch');
    if(sInput) sInput.value = "";

    const hour = new Date().getHours();
    let greetText = "Magandang Araw";
    if (hour < 12) greetText = "Good Morning";
    else if (hour < 18) greetText = "Good Afternoon";
    else greetText = "Good Evening";

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yDate = yesterday.toISOString().split('T')[0];

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <h1 id="greet" style="font-size: 1.2rem; margin: 0; line-height: 1.2;">${greetText}, ${userName}! üëã</h1>
                <p class="sub-text" style="font-size: 0.85rem; margin: 2px 0 0 0;">Narito ang summary ng plant performance ngayong araw.</p>
            </div>
        </div>

        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div class="stat-card">
                <h4>Power Consumption (Yesterday)</h4>
                <div class="value" id="yestTotal">0.00 kWh</div>
                <div class="label"><i class="far fa-calendar-alt"></i> ${yDate}</div>
            </div>

            <div class="stat-card" style="border-left-color: #f6ad55;">
                <h4>Latest GPM Reading</h4>
                <div class="value" id="latestGPM">--</div>
                <div class="label" id="gpmTime">Checking...</div>
                <div id="updateStatus" style="font-size: 0.7rem; margin-top: 5px;"></div> 
            </div>

            <div class="stat-card" style="border-left-color: #2d3748;">
                <h4 style="display: flex; justify-content: space-between;">
                    Next CoalYard Priority 
                    <span id="vacantBadge" style="font-size: 0.6rem; padding: 2px 6px; border-radius: 4px;"></span>
                </h4>
                <div id="dashboard-coal-status" style="margin-top: 5px;">
                    <div class="value" style="font-size: 1.5rem; color: #cbd5e0;">Loading...</div>
                </div>
            </div>
        </div>

        <div id="coal-queue-bar" style="margin-top: 15px;"></div>

        <div class="chart-container" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin:0;">Power Consumption Trend</h4>
                <select onchange="updateChartRange(this.value)" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.8rem;">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                </select>
            </div>
            <canvas id="usageChart"></canvas>
        </div>
    `;

    // Delay para masiguro na rendered na ang HTML bago mag-fetch ng data
    setTimeout(() => {
        if (typeof fetchDashboardData === "function") fetchDashboardData(yDate);
        if (typeof fetchLatestGPM === "function") fetchLatestGPM(); 
        if (typeof checkTodayStatus === "function") checkTodayStatus();
        
        // Tawagin ang syncCoalData para i-process ang currentYardData
        // At ang updateDashboardSidebar para i-render ang coal elements sa dashboard
        if (typeof syncCoalData === "function") {
            syncCoalData(); 
         }
    }, 150);
}
function updateDashboardSidebar() {
    const statusDiv = document.getElementById('dashboard-coal-status');
    const vacantBadge = document.getElementById('vacantBadge'); // Safe to keep for reference
    const queueBar = document.getElementById('coal-queue-bar');

    // Guard clause: Kung wala sa Dashboard page, stop na.
    if (!statusDiv || !queueBar) return;

    const standbyList = [];
    const inUseYards = [];
    const vacantYards = [];
    
    // 1. Kategorya ang lahat ng 9 na Yard (Para sa math accuracy)
    for (let i = 1; i <= 9; i++) {
        const yard = currentYardData[i];
        if (!yard) continue;
        
        if (yard.status === 'vacant') {
            vacantYards.push("YARD" + i);
        } else if (yard.status === 'in use') {
            inUseYards.push("YARD" + i);
        } else if (yard.status === 'standby') {
            standbyList.push({ no: i, ...yard });
        }
    }

    // 2. FIFO Sort para sa Priority
    standbyList.sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
    const nextYard = standbyList[0];

    // 3. Render Next Priority Card (Upper Right Card)
    statusDiv.innerHTML = nextYard ? `
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 3rem; font-weight: 900; color: #2d3748; line-height: 1;">${nextYard.no}</div>
            <div style="line-height: 1.2;">
                <div style="font-weight: 800; font-size: 0.9rem; color: #2b6cb0; text-transform: uppercase;">${nextYard.supplier}</div>
                <div style="font-size: 0.8rem; font-weight: bold; color: #4a5568;">${nextYard.kg.toLocaleString()} kg</div>
                <div style="font-size: 0.65rem; color: #a0aec0;">Arrived: ${nextYard.date}</div>
            </div>
        </div>
    ` : `<div style="font-size: 1.1rem; color: #a0aec0; padding: 10px 0;">No Standby</div>`;

    // Clean up the old badge since we're moving it to the bottom
    if (vacantBadge) vacantBadge.style.display = 'none';

    // 4. Render Standby Queue Bar & Bottom Inventory Summary
    queueBar.innerHTML = `
        <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 15px; width: 100%; box-sizing: border-box; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
            
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f7fafc; padding-bottom: 8px;">
                <span style="font-size: 0.75rem; font-weight: 900; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas fa-list-ol"></i> Standby Inventory Queue of CoalYards
                </span>
                <span style="font-size: 0.65rem; color: #a0aec0; font-weight: bold;">
                    ${standbyList.length} Yards Waiting
                </span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; width: 100%;">
                ${standbyList.map(s => `
                    <div style="background: #f8fafc; border: 1px solid #edf2f7; border-radius: 8px; padding: 12px; border-top: 4px solid #4299e1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 900; color: #1a202c; font-size: 1.2rem;">#${s.no}</span>
                            <span style="background: #ebf8ff; color: #3182ce; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 900;">FIFO</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #2d3748; font-weight: 800; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${s.supplier}">
                            ${s.supplier}
                        </div>
                        <div style="font-size: 0.65rem; color: #718096; margin-top: 4px;">
                            <i class="far fa-calendar-alt"></i> ${s.date}
                        </div>
                    </div>
                `).join('')}
                ${standbyList.length === 0 ? '<div style="grid-column: 1/-1; text-align: center; color:#cbd5e0; padding: 10px;">No yards on standby.</div>' : ''}
            </div>

            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 5px; padding-top: 12px; border-top: 1px dashed #e2e8f0; flex-wrap: wrap;">
                
                <div style="background: #fffaf0; color: #9c4221; border: 1px solid #feebc8; padding: 5px 15px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; gap: 8px;">
                    <span style="height: 10px; width: 10px; background: #ed8936; border-radius: 50%; display: inline-block; animation: pulse 2s infinite;"></span>
                    IN USE: ${inUseYards.length > 0 ? inUseYards.join(', ') : 'NONE'}
                </div>

                <div style="background: #f0fff4; color: #22543d; border: 1px solid #c6f6d5; padding: 5px 15px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; gap: 8px;">
                    <span style="height: 10px; width: 10px; background: #38a169; border-radius: 50%; display: inline-block;"></span>
                    VACANT: ${vacantYards.length > 0 ? vacantYards.join(', ') : 'NONE'}
                </div>

            </div>
        </div>
    `;
}
// Function para i-check kung nag-input na ang operator today
async function checkTodayStatus() {
    const statusEl = document.getElementById('updateStatus');
    if (!statusEl) return;

    const today = new Date().toISOString().split('T')[0];
    const startOfDay = `${today}T00:00:00.000Z`;
    const endOfDay = `${today}T23:59:59.999Z`;

    const { count, error } = await supabaseClient
        .from('gpm_readings')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', startOfDay)
        .lte('created_at', endOfDay);

    if (error) return;

    if (count > 0) {
    statusEl.innerHTML = "<span style='color: #38a169;'>‚óè Updated for today</span>"; 
} else {
        statusEl.innerHTML = "<span style='color: #e53e3e;'>‚óè No data for today</span>";
    }
}
async function fetchLatestGPM() {
    const gpmDisplay = document.getElementById('latestGPM');
    const timeDisplay = document.getElementById('gpmTime');
    
    try {
        // Kunin ang pinaka-latest na record (kahit anong date)
        const { data, error } = await supabaseClient
            .from('gpm_readings')
            .select('gpm, created_at')
            .order('created_at', { ascending: false })
            .limit(1);

        if (error) throw error;

        if (data && data.length > 0) {
            const latest = data[0];
            const readingDate = new Date(latest.created_at);
            const today = new Date();

            // I-format ang Time
            const timeStr = readingDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // I-check kung "Today" o "Ibang Date"
            const isToday = readingDate.toDateString() === today.toDateString();
            
            const dateStr = isToday 
                ? "Today" 
                : readingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Display ang GPM at ang Date/Time
            gpmDisplay.innerText = parseFloat(latest.gpm).toFixed(2) + " GPM";
            timeDisplay.innerHTML = `<i class="far fa-clock"></i> ${timeStr} | <span style="color: ${isToday ? '#48bb78' : '#e53e3e'}; font-weight: bold;">${dateStr}</span>`;
            
        } else {
            gpmDisplay.innerText = "No Data";
            timeDisplay.innerText = "No records found in database";
        }
    } catch (err) {
        console.error("Error fetching latest GPM:", err);
        gpmDisplay.innerText = "Error";
    }
}
async function fetchDashboardData(yDate) {
    // 1. Kunin ang Yesterday's Total
    database.ref('readings/' + yDate).once('value', (snapshot) => {
        const data = snapshot.val();
        let total = 0;
        if (data) {
            Object.keys(data).forEach(key => {
                if(key !== 'metadata') {
                    total += parseFloat(data[key].usage) || 0;
                }
            });
        }
        const yestElem = document.getElementById('yestTotal');
        if (yestElem) {
            yestElem.innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2}) + " kWh";
        }
    });

    // 2. LOGIC PARA SA LAST 7 DAYS CHART
    const labels = [];
    const datePromises = [];

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        
        labels.push(dayName);
        
        const promise = database.ref('readings/' + dateStr).once('value').then(snap => {
            const dayReadings = snap.val();
            let dayTotal = 0;
            if (dayReadings) {
                Object.keys(dayReadings).forEach(k => {
                    if (k !== 'metadata') dayTotal += parseFloat(dayReadings[k].usage) || 0;
                });
            }
            return dayTotal;
        });
        datePromises.push(promise);
    }

    // Hintayin matapos ang fetch
    const results = await Promise.all(datePromises);

    // --- SAFETY CHECK DITO ---
    const canvas = document.getElementById('usageChart');
    if (!canvas) {
        console.warn("Usage Chart element missing. User likely navigated away.");
        return; // Itigil ang function, huwag mag-error
    }

    const ctx = canvas.getContext('2d');
    
    // I-render na ang Chart
    if (window.myUsageChart) { window.myUsageChart.destroy(); }

    window.myUsageChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Consumption (kWh)',
                data: results,
                borderColor: '#3182ce',
                backgroundColor: 'rgba(49, 130, 206, 0.1)',
                fill: true,
                tension: 0.3,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#3182ce'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toLocaleString() + ' kWh';
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString() } 
                } 
            }
        }
    });
}

// Para automatic mag-load ang dashboard pagka-login
// Idagdag ang loadDashboard() sa loob ng login() function mo.

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }
       function logout() {
    // Linisin ang lahat ng bakas ng user
    localStorage.removeItem('userCode');
    localStorage.removeItem('isLoggedIn'); // Kung ginagamit mo pa ito
    window.location.href = 'login.html';
}
        // PAG-CHECK KUNG NAKA-LOG IN NA DATI
window.onload = function() {
    // 1. Kunin ang data mula sa localStorage (na sinave ng login.html)
    const userCode = localStorage.getItem('userCode');
    const userName = localStorage.getItem('userName');
    const userRole = localStorage.getItem('userRole');
    const userAvatar = localStorage.getItem('userAvatar');

    // 2. Security Check: Kung walang data, balik sa login page
    if (!userCode) {
        window.location.href = 'login.html';
        return;
    }

    // 3. I-display ang User Info (Pangalan, Role, at Avatar)
    // Hindi na natin kailangan ang db[userCode] dito!
    if (document.getElementById('pName')) document.getElementById('pName').innerText = userName;
    if (document.getElementById('pRole')) document.getElementById('pRole').innerText = userRole;
    
    if (document.getElementById('profileBtn')) {
        const profilePath = 'assets/' + userAvatar;
        document.getElementById('profileBtn').style.backgroundImage = `url('${profilePath}')`;
    }

    // 4. Supabase Realtime Subscription (Mananatili ito)
    const gpmSubscription = supabaseClient
        .channel('custom-all-channel')
        .on('postgres_changes', 
            { event: 'INSERT', schema: 'public', table: 'gpm_readings' }, 
            payload => {
                if(document.getElementById('latestGPM')) fetchLatestGPM(); 
                if(document.getElementById('updateStatus')) checkTodayStatus();
                if(document.getElementById('gpmTableBody')) fetchGPMLogs(); 
            }
        )
        .subscribe();

    // 5. Idle Timer
    let idleTime = 0;
    document.onmousemove = () => idleTime = 0;
    document.onkeypress = () => idleTime = 0;
    setInterval(() => {
        idleTime++;
        if (idleTime >= 30) { logout(); }
    }, 60000);

    loadDashboard();
};
    
        function expandSidebarForSearch() {
    const sidebar = document.getElementById('sidebar');
    const content = document.querySelector('.content');
    const searchInput = document.getElementById('sidebarSearch');

    // Kung naka-collapsed ang sidebar, buksan ito
    if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        content.classList.remove('expanded');
        
        // Bigyan ng konting delay bago mag-focus para tapos na ang animation
        setTimeout(() => {
            searchInput.focus();
        }, 300);
    } else {
        // Kung bukas na, focus agad sa input
        searchInput.focus();
    }
}
        function handleSidebarSearch() {
    const searchValue = document.getElementById('sidebarSearch').value.toLowerCase();
    
    // Hanapin ang kahit anong table body na kasalukuyang naka-display
    const tableBody = document.querySelector('tbody');
    
    if (!tableBody) return; // Wag gumalaw kung walang table

    const rows = tableBody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const rowText = rows[i].textContent.toLowerCase();
        
        // Kung ang tinype mo ay nahanap sa loob ng text ng row
        if (rowText.includes(searchValue)) {
            rows[i].style.display = ""; // Ipakita
        } else {
            // Itago ang row kung hindi match, maliban na lang kung "No data" ang message
            if (!rowText.includes("no readings found") && !rowText.includes("loading")) {
                rows[i].style.display = "none"; 
            }
        }
    }
}
        async function fetchUsers() {
    const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .neq('company_id', '090909')
        .order('is_approved', { ascending: true }); // Para maunang lumitaw yung mga pending

    const tbody = document.getElementById('userTableBody');
    if(!tbody) return; // Guard clause kung wala pa sa screen yung table

    if (error) {
        tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
        return;
    }

    tbody.innerHTML = ""; 

    data.forEach(user => {
        const isPending = !user.is_approved;
        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s;">
                <td style="padding: 12px; display: flex; align-items: center; gap: 10px;">
                    <img src="assets/${user.avatar_url}" style="width: 30px; height: 30px; border-radius: 50%;">
                    <span>${user.full_name}</span>
                </td>
                <td>${user.company_id}</td>
                <td style="font-size: 0.8rem; opacity: 0.7;">${user.role}</td>
                <td>
                    <span style="padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; background: ${isPending ? 'rgba(245,101,101,0.2)' : 'rgba(72,187,120,0.2)'}; color: ${isPending ? '#f56565' : '#48bb78'};">
                        ${isPending ? 'PENDING' : 'ACTIVE'}
                    </span>
                </td>
                <td style="text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        ${isPending ? `<button onclick="approveUser('${user.company_id}')" style="background:#48bb78; border:none; color:white; padding: 5px 8px; border-radius: 4px; cursor:pointer;"><i class="fas fa-check"></i></button>` : ''}
                        <button onclick="resetPassword('${user.company_id}')" style="background:#4299e1; border:none; color:white; padding: 5px 8px; border-radius: 4px; cursor:pointer;"><i class="fas fa-key"></i></button>
                        <button onclick="deleteUser('${user.company_id}')" style="background:#f56565; border:none; color:white; padding: 5px 8px; border-radius: 4px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
    });
}
        function loadUserManagement(element) {
    // 1. Sidebar Active State
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    element.classList.add('active');

    const content = document.getElementById('cont');
    
    // Inayos ang structure para maging "Responsive Flex" ang header
    content.innerHTML = `
    <div style="padding: 10px 0; animation: slideDown 0.3s ease;">
        <div style="
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 25px;
            padding-right: 60px; /* <--- ITO ANG SOLUSYON: Nag-iwan tayo ng space para sa Profile Circle */
        ">
            <div style="flex: 1; min-width: 200px;">
                <h2 style="margin: 0; color: var(--text-main); font-size: 1.5rem; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-users-cog" style="color: var(--accent);"></i> 
                    <span>User Management</span>
                </h2>
            </div>
            
            <button onclick="fetchUsers()" style="
                background: var(--accent); 
                color: white; 
                border: none; 
                padding: 10px 18px; 
                border-radius: 8px; 
                font-weight: 600; 
                cursor: pointer; 
                display: flex; 
                align-items: center; 
                gap: 8px; 
                box-shadow: 0 4px 12px rgba(56, 161, 105, 0.2);
                transition: var(--transition);
                z-index: 10; /* Siguraduhin na clickable pa rin */
            ">
                <i class="fas fa-sync-alt"></i> Refresh List
            </button>
        </div>
            
            <div class="data-card" style="margin-top: 0; overflow: hidden;">
                <div style="overflow-x: auto;">
                    <table style="min-width: 700px;">
                        <thead>
                            <tr>
                                <th style="padding: 15px;">Operator</th>
                                <th>Company ID</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 40px; color: var(--text-sub);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading operators...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    fetchUsers();
}
        // --- FUNCTION PARA SA RESET PASSWORD ---
async function resetPassword(id) {
    const newPass = prompt("Enter new password for this operator:", "123456");
    
    if (newPass === null) return; // Pag pinindot ang 'Cancel'
    if (newPass.trim() === "") return alert("Password cannot be empty!");

    const { error } = await supabaseClient
        .from('profiles')
        .update({ password: newPass })
        .eq('company_id', id);

    if (error) {
        alert("Error resetting password: " + error.message);
    } else {
        alert("Password for ID " + id + " has been reset to: " + newPass);
    }
}
async function approveUser(id) {
    // 1. Confirmation box para hindi aksidente ang pag-approve
    if (confirm("Approve this operator for system access?")) {
        
        // 2. Update ang 'is_approved' column sa Supabase
        const { error } = await supabaseClient
            .from('profiles')
            .update({ is_approved: true })
            .eq('company_id', id);

        if (error) {
            alert("Approval Failed: " + error.message);
        } else {
            alert("Operator " + id + " is now APPROVED!");
            
            // 3. I-refresh ang listahan para mawala ang approve button 
            // at maging 'ACTIVE' ang status badge
            if (typeof fetchUsers === "function") {
                fetchUsers();
            }
        }
    }
}
// --- FUNCTION PARA SA PAG-DELETE NG USER ---
async function deleteUser(id) {
    if (confirm("Are you sure you want to PERMANENTLY delete this operator?")) {
        const { error } = await supabaseClient
            .from('profiles')
            .delete()
            .eq('company_id', id);

        if (error) {
            alert("Error deleting user: " + error.message);
        } else {
            alert("User deleted successfully.");
            fetchUsers(); // I-refresh ang table para mawala na siya sa listahan
        }
    }
}
    </script>
</body>
</html>
